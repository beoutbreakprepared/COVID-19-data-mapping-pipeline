<!DOCTYPE html>
<html lang="en">
<head>
  <title>Novel Coronavirus (COVID-19)</title>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.7.2/bluebird.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.4/fetch.min.js"></script>
  <link rel="stylesheet" type="text/css" href="css/fonts.css" />
  <link rel="stylesheet" type="text/css" href="css/styles.css?c" />
</head>
<body>
  <div class="modal-wrapper" id="modal-wrapper">
    <div class="modal-backdrop"></div>
    <div class="modal" id="modal">
      <div class="modal-header">
        <div class="modal-title">About this Map</div>
        <div class="modal-cancel" onClick=handleHideModal()><img src="img/close-icon.svg" width="20" height="20" alt="Close" /></div>
      </div>
      <div class="modal-body">
        <p>The Covid-19 map visualizes a deep and meticulous dataset that is freely accessible to anyone involved in coronavirus research; something that represents a completely new approach to how we collect data and make it readily available during an outbreak. The data changes the game in terms of how we respond to new global threats such as these.</p>
        <h2>Data</h2>
    	  <p>All data used to produce this map are exclusively collected from publicly available sources including government reports and news media.</p>
        <p>Datasets and resources can be found in <a href="https://github.com/beoutbreakprepared/nCoV2019" target="new">GitHub</a>.</p>

        <h2>Participating Institutions</h2>
        <div class="logos">
          <img src="img/oxford-blue.svg" class="oxford-logo" alt="University of Oxford" />
          <img src="img/hm-logo-color.svg" class="hm-logo" alt="HealthMap" />
          <img src="img/harvard-logo-color.svg" class="hms-logo" alt="Harvard Medical School" />
          <img src="img/BCH_Primary_Logo.svg" class="bch-logo" alt="Boston Children's Hospital" />
          <img src="img/netsi.png" class="netsi-logo" alt="Network Science Institute at Northeastern University" />
          <img src="img/Oxford_Martin_School_Logo_color.png" class="oxford-martin-logo" alt="Oxford Martin School" />
          <img src="img/Tsinghua_University.png" class="tsinghua-logo" alt="Tsinghua University" />
          <img src="img/IHME_logo_acr_color_large.png" class="ihme-logo" alt="Institute for Health Metrics and Evaluation" />
        </div>

        <h2>Collaborators</h2>
        <ul>
      	  <li>Isha Berry, <a href="mailto:isha.berry@mail.utoronto.ca">isha.berry@mail.utoronto.ca</a></li>
          <li>Thomas Brewer, <a href="mailto:Thomas.Brewer@childrens.harvard.edu">Thomas.Brewer@childrens.harvard.edu</a></li>
          <li>John Brownstein, <a href="mailto:John.Brownstein@childrens.harvard.edu">John.Brownstein@childrens.harvard.edu</a></li>
          <li>Emily Cohn, <a href="mailto:Emily.Cohn@childrens.harvard.edu">Emily.Cohn@childrens.harvard.edu</a></li>
          <li>Lauren Goodwin, <a href="mailto:Lauren.Goodwin@childrens.harvard.edu">Lauren.Goodwin@childrens.harvard.edu</a></li>
          <li>Bernardo Gutierrez, <a href="mailto:bernardo.gutierrez@zoo.ox.ac.uk">bernardo.gutierrez@zoo.ox.ac.uk</a></li>
          <li>Sarah Hill, <a href="mailto:sarah.hill@zoo.ox.ac.uk">sarah.hill@zoo.ox.ac.uk</a></li>
          <li>Erin Hulland, <a href="mailto:ehulland@uw.edu">ehulland@uw.edu</a></li>
          <li>Moritz Kraemer, <a href="mailto:moritz.kraemer@zoo.ox.ac.uk">moritz.kraemer@zoo.ox.ac.uk</a></li>
      		<li>Anastasia Lambrou, <a href="mailto:anastasia.lambrou@jhu.edu">anastasia.lambrou@jhu.edu</a></li>
          <li>Sabrina Li, <a href="mailto:sabrina.li@ouce.ox.ac.uk">sabrina.li@ouce.ox.ac.uk</a></li>
          <li>Alyssa Loskill, <a href="mailto:aloskill@bu.edu">aloskill@bu.edu</a></li>
          <li>Sumiko Mekaru, <a href="mailto:srmekaru@gmail.com">srmekaru@gmail.com</a></li>
          <li>Julia Morgan, <a href="mailto:morgaj5@uw.edu">morgaj5@uw.edu</a></li>
          <li>Katelynn O'Brien, <a href="mailto:katelynn.obrien@childrens.harvard.edu">katelynn.obrien@childrens.harvard.edu</a></li>
          <li>David Pigott, <a href="mailto:pigottdm@uw.edu">pigottdm@uw.edu</a></li>
      		<li>Oliver Pybus, <a href="mailto:oliver.pybus@zoo.ox.ac.uk">oliver.pybus@zoo.ox.ac.uk</a></li>
          <li>Sam Scarpino, <a href="mailto:s.scarpino@northeastern.edu">s.scarpino@northeastern.edu</a></li>
          <li>Kara Sewalk, <a href="mailto:Kara.Sewalk@childrens.harvard.edu">Kara.Sewalk@childrens.harvard.edu</a></li>
      		<li>Lin Wang, <a href="mailto:lin.wang@pasteur.fr">lin.wang@pasteur.fr</a></li>
          <li>Jessie Wu, <a href="mailto:chiehhsi.wu@gmail.com">chiehhsi.wu@gmail.com</a></li>
          <li>Bo Xu, <a href="mailto:xu-b15@mails.tsinghua.edu.cn">xu-b15@mails.tsinghua.edu.cn</a></li>
          <li>Alex Zarebski, <a href="mailto:aezarebski@gmail.com">aezarebski@gmail.com</a></li>
        </ul>

        <h2>News and Publications</h2>
        <ul>
          <li><a href="https://www.independent.co.uk/voices/coronavirus-covid-19-pandemic-outbreak-data-research-cdc-who-a9406281.html">I’m a researcher who’s helped change how we tackle pandemics like coronavirus forever – this is what we’ve learned</a> • Independant</li>
          <li><a href="https://www.thelancet.com/journals/laninf/article/PIIS1473-3099(20)30119-5/fulltext">Open access epidemiological data from the COVID-19 outbreak</a> • The Lancet</li>
        </ul>

      </div>
    </div>
  </div>
  <div class="page-wrapper">
    <div class="sidebar">
      <div class="pullbar"></div>
      <div class="sidebar-header">
        <img src="img/hm-logo-color-white-text.svg" alt="HealthMap" />
        <h1 class="sidebar-title">COVID-19</h1>
      </div>
      <div class="reported-cases" onClick="handleFlyTo(10, 0, 1)">
        <div class="reported-cases-num" id="total-cases"></div>
        <div class="reported-cases-subtext">
          <div class="reported-cases-label">Confirmed cases worldwide</div>
          <div class="last-updated-date">Updated <span id="last-updated-date"></span></div>
        </div>
      </div>
      <ul id="location-list" class="location-list"></ul>
    </div>
    <div class="map-wrapper">
      <div class="mobile-header">
        <img src="img/hm-logo-color-white-text.svg" alt="HealthMap" />
        <h1 class="mobile-title">COVID-19</h1>
      </div>
      <div class="map-type-toggle">
        <button class="is-active">Line List</button>
        <button>WHO Data</button>
      </div>
      <button id="toggle-modal" onClick="handleShowModal()">About<span> this </span> Map</button>
      <div id="legend" class="legend">
        <div class="legend-header">COVID-19 Cases</div>
        <ul>
          <li style="height:80px; z-index:1">
            <span class="circle" style="width:80px; height:80px; background-color: #EDF91C;"></span>
            <span class="label"><span class="label-val">10,000+</span></span>
          </li>
          <li style="height:66px; z-index:2">
            <span class="circle" style="width:66px; height:66px; background-color: #FB9533;"></span>
            <span class="label"><span class="label-val">2000</span></span>
          </li>
          <li style="height:54px; z-index:3">
            <span class="circle" style="width:54px; height:54px; background-color: #D34D60;"></span>
            <span class="label"><span class="label-val">500</span></span>
          </li>
          <li style="height:40px; z-index:4">
            <span class="circle" style="width:40px; height:40px; background-color: #921694;"></span>
            <span class="label"><span class="label-val">100</span></span>
          </li>
          <li style="height:20px; z-index:5">
            <span class="circle" style="width:20px; height:20px; background-color: #67009E;"></span>
            <span class="label"><span class="label-val">10</span></span>
          </li>
        </ul>
        <div class="new-cases">
          <span class="circle" style="background-color: cornflowerblue;"></span>
          <span class="label"><span class="label-val">New</span></span>
        </div>
      </div>
      <div class="range-slider">
    	  <div id="spread"><img src="./img/play.svg" width="20" height="20" alt="Play" /><span class="spread-label">Play</span></div>
        <input id="slider" type="range" value="1000" min="0" max="1000" step="1" />
        <label>Week of <span id="date"></span></label>
      </div>
      <div id="map"></div>
    </div>
  </div>
  <!--
    <div class="credit"><span>In collaboration with the Open COVID-19 Data Curation Group <a href=" https://github.com/beoutbreakprepared/nCoV2019/tree/master/latest_data" target="new">COVID-19 Dataset</a></span></div>
  -->
  <script type="text/javascript">
    // polyfill for array.includes()
    if (!Array.prototype.includes) {
      Array.prototype.includes = function (search, start) {
        'use strict';

        if (search instanceof RegExp) {
          throw TypeError('first argument must not be a RegExp');
        }
        if (start === undefined) { start = 0; }
        return this.indexOf(search, start) !== -1;
      };
    }

    var dataUrl = './dailies.geojson?nocache=' + (new Date()).getTime();
    var latestCountsUrl = './latestCounts.json?nocache=' + (new Date()).getTime();
    var whoUrl = './who.json?nocache=' + (new Date()).getTime();

    var dates = [];
    var timeControl = document.getElementById("slider");
    var timeLabel = document.getElementById("date");

    var totalCases = document.getElementById("total-cases");
    var lastUpdatedDate = document.getElementById("last-updated-date");

    var modalWrapper = document.getElementById("modal-wrapper");
    var modal = document.getElementById("modal");
    var playButton = document.getElementById("spread");

    // load latest counts from scraper
    fetch(latestCountsUrl)
      .then(function(res) { return res.json(); })
      .then(function(res) {
        totalCases.innerText = res[0].caseCount
        lastUpdatedDate.innerText = res[0].date
      });

    // build list of locations with counts
    fetch(whoUrl)
      .then(function(res) { return res.json(); })
      .then(function(res) {
        var obj = res.features
        list = '';
        for (let key in obj) {
          let location = obj[key];
          var name = location.attributes.ADM0_NAME;
          var lat = location.centroid.x;
          var lon = location.centroid.y;
          var cumConf = location.attributes.cum_conf;
          var legendGroup = 'legend-group-default';
          // do this in pipeline ?
          switch (true) {
            case cumConf<=10: legendGroup='legend-group-10'; break;
            case cumConf>10 && cumConf<=100: legendGroup='legend-group-100'; break;
            case cumConf>100 && cumConf<=500: legendGroup='legend-group-500'; break;
            case cumConf>500 && cumConf<=2000: legendGroup='legend-group-2000'; break;
          }
          list += '<li><button onClick="handleFlyTo(' + lat + ',' + lon + ',' + 3 + ')"><span class="label">' + name + '</span><span class="num ' + legendGroup + '">' + cumConf + '</span></span></button></li>';
        }
        document.getElementById('location-list').innerHTML = list;
      });

    var handleShowModal = function () {
      // switch elements to have 'display' value (block, flex) but keep hidden via opacity
      modalWrapper.classList.add('is-block');
      modal.classList.add('is-flex');
      setTimeout(function () {
        // for transition
        modalWrapper.classList.add('is-visible');
        modal.classList.add('is-visible');
      }, 40);
    }
    var handleHideModal = function () {
      modalWrapper.classList.remove('is-visible');
      modal.classList.remove('is-visible');
      setTimeout(function () {
        // for transition
        modalWrapper.classList.remove('is-block');
        modal.classList.add('is-flex');
      }, 400);
    }

    function initMap() {
      mapboxgl.accessToken = 'pk.eyJ1Ijoia2F0ZWx5bm5vYnJpZW4iLCJhIjoiY2sxa3ZjbTR4MDA2bTNjcGR4cXIwZnJidSJ9.wrkfV082TaX5P65i2L8upg';
      var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/katelynnobrien/ck5y23wmc0aso1iqtbww5nzrr',
        center: [10, 0],
        zoom: 1,
        maxZoom: 8,
        // hash: true
      }).addControl(new mapboxgl.NavigationControl());

      var animateMap = function() {
        var i = 0;
        var stepMap = setInterval(function() {
          timeControl.value = i;
          filterBy(dates[i]);
          setTimeControlLabel(i);
          i++;
          if(i === dates.length) {
            clearInterval(stepMap);
          }
        }, 500);
      }

      window.handleFlyTo = function(lat, lon, zoom, item) {
        console.log(item)
        map.flyTo({ center: [lat, lon], zoom: zoom })
        window.scrollTo({
          top: 0,
          left: 0,
          behavior: 'smooth'
        });
      }

      function filterBy(isodate) {
        var filters = ['==', 'date', isodate];
        map.setFilter('daily', filters);
        map.setFilter('totals', filters);
      }

      function setTimeControlLabel(date) {
        timeLabel.innerText = dates[date];
      };

      function buildTimeControl() {
        timeControl.setAttribute("max", dates.length - 1)
        timeControl.setAttribute("value", dates.length - 1);
        setTimeControlLabel(dates.length - 1);
      };

      timeControl.addEventListener("input", function() {
        setTimeControlLabel(timeControl.value);
        filterBy(dates[timeControl.value]);
      });

      map.on('load', function () {
        map.addSource('counts', {
          'type': 'geojson',
          'data': {
            'type': 'FeatureCollection',
            'features': []
          }
        });
        map.addLayer({
          'id': 'totals',
          'type': 'circle',
          'source': 'counts',
          'paint': {
            'circle-radius': ['*', ['log10', ['sqrt', ['get', 'total']]], 20],
            'circle-color': [
              'step',
              ['get', 'total'],
              '#67009E',
              10,
              '#921694',
              100,
              '#D34d60',
              500,
              '#FB9533',
              2000,
              '#EDF91C',
            ],
            'circle-opacity': .6,
          }
        });
        map.addLayer({
          'id': 'daily',
          'type': 'circle',
          'source': 'counts',
          'paint': {
            'circle-radius': [ 'case', ['<', 0, ['number', ['get', 'new']]], ['*', ['log10', ['sqrt', ['get', 'new']]], 20], 0 ],
            'circle-color': 'cornflowerblue',
            'circle-opacity': 0.6,
          }
        });

        // Create a popup, but don't add it to the map yet.
        var popup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false
        });

        // Create a popup, but don't add it to the map yet.
        var popup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false
        });

        map.on('mouseenter', 'totals', function (e) {
          // Change the cursor style as a UI indicator.
          map.getCanvas().style.cursor = 'pointer';

          var coordinates = e.features[0].geometry.coordinates.slice();
          var props = e.features[0].properties;
          var city = props.city ? props.city + ', ' : '';
          var province = props.province ? props.province + ', ' : '';
          var country = props.country ? props.country : '';
          var description =
            '<h3 class="popup-header">' + city + province + country + '</h3>' +
            '<div>' + '<strong>Number of Cases: </strong>' + props.total + '</div>';

          // Ensure that if the map is zoomed out such that multiple
          // copies of the feature are visible, the popup appears
          // over the copy being pointed to.
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }

          // Populate the popup and set its coordinates
          // based on the feature found.
          popup
            .setLngLat(coordinates)
            .setHTML(description)
            .addTo(map);
        });

        map.on('mouseleave', 'totals', function () {
          map.getCanvas().style.cursor = '';
          popup.remove();
        });

        // fetch(totalsUrl).then(res => res.json()).then(res => {
        //     map.getSource('cumulative').setData(res);
        // });

        fetch(dataUrl)
        .then(function(res) { return res.json(); })
        .then(function(res) {
          var datesUnsorted = [];
          res.features.forEach(function(feature) {
            var date = feature.properties.date;
            if (!datesUnsorted.includes(date)) {
              datesUnsorted.push(date)
            }
          });
          dates = datesUnsorted.sort();
          buildTimeControl();
          map.getSource('counts').setData(res);
          filterBy(dates[dates.length - 1]);
          playButton.addEventListener("click", function () {
            animateMap();
          });
        });

      });
    }


  </script>
  <script async defer src="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.js" onload="initMap()"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.css" rel="stylesheet" />

</body>
</html>
